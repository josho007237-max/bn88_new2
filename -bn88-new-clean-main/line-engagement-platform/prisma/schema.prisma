generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "debian-openssl-1.1.x"]
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model Audience {
  id           String    @id @default(cuid())
  lineUserId   String    @unique
  displayName  String?
  locale       String?

  // สำคัญ: ต้องเป็น list เพื่อใช้ hasSome/hasEvery/has และกัน update พังด้วย default []
  tags         String[]  @default([])

  lastActiveAt DateTime? @db.Timestamptz
  createdAt    DateTime  @default(now()) @db.Timestamptz
  updatedAt    DateTime  @updatedAt @db.Timestamptz

  events       Event[]
  deliveries   CampaignDelivery[]

  @@index([lastActiveAt])
}

model Event {
  id         String    @id @default(cuid())
  type       String
  payload    Json
  occurredAt DateTime  @default(now()) @db.Timestamptz

  audienceId String?
  audience   Audience? @relation(fields: [audienceId], references: [id], onDelete: SetNull, onUpdate: Cascade)

  @@index([audienceId])
  @@index([occurredAt])
  @@index([type])
}

model Campaign {
  id             String    @id @default(cuid())
  externalId     String?   @unique

  name           String

  // สำคัญ: code ของคุณใช้งาน message
  message        String

  // สำคัญ: code ของคุณใช้งาน status/sentCount/failedCount/totalTargets
  status         String    @default("draft")
  totalTargets   Int       @default(0)
  sentCount      Int       @default(0)
  failedCount    Int       @default(0)

  scheduleStart  DateTime? @db.Timestamptz
  scheduleEnd    DateTime? @db.Timestamptz
  cron           String?

  // บางจุดใช้ enabled ในฝั่ง campaign ด้วย
  enabled        Boolean   @default(true)

  segmentType    String?
  segmentQuery   Json?
  messagePayload Json?

  createdAt      DateTime  @default(now()) @db.Timestamptz
  updatedAt      DateTime  @updatedAt @db.Timestamptz

  deliveries     CampaignDelivery[]
  schedules      CampaignSchedule[]

  @@index([status])
  @@index([enabled])
}

model CampaignDelivery {
  id         String    @id @default(cuid())
  campaignId String
  audienceId String

  status     String
  sentAt     DateTime? @db.Timestamptz
  error      String?

  campaign   Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  audience   Audience  @relation(fields: [audienceId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([audienceId])
  @@index([status])
}

model CampaignSchedule {
  id             String    @id @default(cuid())
  campaignId     String

  // code ใช้ cronExpression แต่ใน schema ใช้ cron (ให้ไป map ใน code หรือเปลี่ยน code ให้ใช้ cron)
  cron           String

  timezone       String
  startAt        DateTime? @db.Timestamptz
  endAt          DateTime? @db.Timestamptz

  // สำคัญ: code เรียก enabled
  enabled        Boolean   @default(true)

  // สำคัญ: code เรียก repeatJobKey
  repeatJobKey   String?   @unique

  // สำคัญ: code ส่ง null ได้ → ให้เป็น nullable
  idempotencyKey String?   @unique

  createdAt      DateTime  @default(now()) @db.Timestamptz
  updatedAt      DateTime  @updatedAt @db.Timestamptz

  campaign       Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([enabled])
}
