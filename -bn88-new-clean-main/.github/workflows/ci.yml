name: CI

on:
  push:
    branches: ["main"]
  pull_request:
    branches: ["main"]

jobs:
  backend:
    name: Backend Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: bn88-backend-v12
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres" --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: |
            bn88-backend-v12/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build -- --pretty false --noEmit | tee ../backend-build.log

      - name: Debug versions/env
        run: |
          node -v
          npm -v
          echo $DATABASE_URL

      - name: Test
        run: npm run test --if-present | tee ../backend-test.log

      - name: Upload backend logs
        uses: actions/upload-artifact@v4
        with:
          name: backend-logs
          path: |
            backend-build.log
            backend-test.log

  frontend:
    name: Frontend Build & Test
    runs-on: ubuntu-latest
    defaults:
      run:
        working-directory: bn88-frontend-dashboard-v12
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: |
            bn88-frontend-dashboard-v12/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Build
        run: npm run build | tee ../frontend-build.log

      - name: Debug versions/env
        run: |
          node -v
          npm -v
          echo $DATABASE_URL

      - name: Test
        run: npm run test --if-present | tee ../frontend-test.log

      - name: Upload frontend logs
        uses: actions/upload-artifact@v4
        with:
          name: frontend-logs
          path: |
            frontend-build.log
            frontend-test.log

  prisma-validate:
    name: Prisma Validation
    runs-on: ubuntu-latest
    needs: backend
    defaults:
      run:
        working-directory: bn88-backend-v12

    # ✅ ใส่ env ระดับ JOB กันพลาด/กันโดนทับ
    env:
      DATABASE_URL: "file:./dev.db"

    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres" --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: |
            bn88-backend-v12/package-lock.json

      - name: Install dependencies
        run: npm ci

      - name: Debug versions/env
        run: |
          node -v
          npm -v
          echo $DATABASE_URL

      - name: Prisma validate
        run: npx prisma validate

  integration:
    name: Integration Tests
    runs-on: ubuntu-latest
    needs: [backend, frontend]
    defaults:
      run:
        working-directory: bn88-backend-v12
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_USER: postgres
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: postgres
        ports:
          - 5432:5432
        options: >-
          --health-cmd "pg_isready -U postgres" --health-interval 10s --health-timeout 5s --health-retries 5
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 18
          cache: npm
          cache-dependency-path: |
            bn88-backend-v12/package-lock.json
            bn88-frontend-dashboard-v12/package-lock.json

      - name: Install backend deps
        run: npm ci

      - name: Install frontend deps
        working-directory: bn88-frontend-dashboard-v12
        run: npm ci

      - name: Debug versions/env
        run: |
          node -v
          npm -v
          echo $DATABASE_URL

      - name: Run integration tests
        env:
          DATABASE_URL: "file:./dev.db"
        run: npm run test:integration --if-present -- --runInBand | tee ../integration-test.log

      - name: Upload integration logs
        uses: actions/upload-artifact@v4
        with:
          name: integration-logs
          path: integration-test.log
