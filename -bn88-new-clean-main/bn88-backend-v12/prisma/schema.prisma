generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "sqlite"
  url      = env("DATABASE_URL")
}

/**
 * ====================== Tenants & Audit ===========================
 */

model Tenant {
  id        String   @id @default(cuid())
  code      String   @unique
  name      String
  status    String   @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model AuditLog {
  id               String   @id @default(cuid())
  tenant           String
  actorAdminUserId String?
  action           String
  target           String?
  diffJson         Json?
  createdAt        DateTime @default(now())

  @@index([tenant, createdAt])
}

/**
 * ====================== Admin & Core Bot Models ======================
 */

model Role {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  admins      AdminUserRole[]
  permissions RolePermission[]
}

model Permission {
  id          String   @id @default(cuid())
  name        String   @unique
  description String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  roles RolePermission[]
}

model AdminUser {
  id        String   @id @default(cuid())
  email     String   @unique
  password  String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // relation หลายต่อหลาย ผ่านตารางกลาง AdminUserRole
  roles AdminUserRole[]
}

model AdminUserRole {
  adminId    String
  roleId     String
  admin      AdminUser @relation(fields: [adminId], references: [id], onDelete: Cascade)
  role       Role      @relation(fields: [roleId], references: [id], onDelete: Cascade)
  assignedAt DateTime  @default(now())

  @@id([adminId, roleId])
}

/**
 * ====================== Webhook & Media ===========================
 */

model WebhookEvent {
  id          String   @id @default(cuid())
  tenant      String
  provider    String
  eventId     String
  signatureOk Boolean  @default(false)
  receivedAt  DateTime @default(now())
  rawJson     Json?
  createdAt   DateTime @default(now())

  @@unique([tenant, provider, eventId], name: "webhook_event_unique")
  @@index([tenant, provider, receivedAt])
}

model MediaAsset {
  id            String   @id @default(cuid())
  tenant        String
  provider      String
  contentId     String
  mimeType      String?
  size          Int?
  storageKey    String?
  sha256        String?
  sessionId     String?
  chatMessageId String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  session ChatSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  message ChatMessage? @relation(fields: [chatMessageId], references: [id], onDelete: SetNull)

  @@unique([tenant, provider, contentId], name: "media_tenant_provider_content_unique")
  @@index([tenant, provider])
}

model RolePermission {
  roleId       String
  permissionId String
  role         Role       @relation(fields: [roleId], references: [id], onDelete: Cascade)
  permission   Permission @relation(fields: [permissionId], references: [id], onDelete: Cascade)
  createdAt    DateTime   @default(now())

  @@id([roleId, permissionId])
}

model Bot {
  id         String    @id @default(cuid())
  tenant     String
  name       String
  platform   String    @default("line") // line / telegram / facebook / webchat ฯลฯ
  active     Boolean   @default(true)
  verifiedAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  secret             BotSecret?
  config             BotConfig?
  cases              CaseItem[] // ✅ เคสทั้งหมดของบอทนี้
  stats              StatDaily[]
  knowledgeLink      BotKnowledge[]
  intents            BotIntent[] // ✅ relation ไปยัง Intent
  chatSessions       ChatSession[]
  chatMessages       ChatMessage[]
  conversations      Conversation[]
  faqs               FAQ[]
  engagementMessages EngagementMessage[]
  faqEntries         FaqEntry[]
  dailyRules         DailyRule[]
  codePools          CodePool[]
  imageIntakes       ImageIntake[]

  @@unique([tenant, name], name: "tenant_name")
}

model DailyRule {
  id         String @id @default(cuid())
  tenant     String
  botId      String
  platform   String
  channelKey String @default("default") // ถ้าไม่มี channel/group ให้ใช้ "default"
  dateKey    String // "YYYY-MM-DD"

  conditions    Json
  passReply     String
  failReply     String
  reviewReply   String
  needInfoReply String

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot       Bot        @relation(fields: [botId], references: [id], onDelete: Cascade)
  codePools CodePool[]

  @@unique([tenant, botId, platform, channelKey, dateKey], map: "daily_rule_unique")
  @@index([tenant, botId, dateKey])
}

model CodePool {
  id     String     @id @default(cuid())
  tenant String
  botId  String
  ruleId String? // ผูกกับ DailyRule (ถ้าต้องการแยกโค้ดตามกิจกรรม)
  code   String
  status CodeStatus @default(AVAILABLE)

  expiresAt DateTime?
  usedAt    DateTime?
  usedBy    String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot             Bot              @relation(fields: [botId], references: [id], onDelete: Cascade)
  rule            DailyRule?       @relation(fields: [ruleId], references: [id], onDelete: SetNull)
  codeRedemptions CodeRedemption[]

  @@unique([tenant, botId, code], name: "code_unique_per_bot")
  @@index([tenant, botId, status])
}

model ImageIntake {
  id         String @id @default(cuid())
  tenant     String
  botId      String
  platform   String
  channelKey String @default("default")

  userId        String
  sessionId     String? // ผูก ChatSession ได้ถ้ามี
  chatMessageId String? // ผูก ChatMessage ได้ถ้ามี

  imageUrl       String
  classification ImageClass
  confidence     Float?
  rawJson        Json?

  createdAt DateTime @default(now())

  bot     Bot          @relation(fields: [botId], references: [id], onDelete: Cascade)
  session ChatSession? @relation(fields: [sessionId], references: [id], onDelete: SetNull)
  message ChatMessage? @relation(fields: [chatMessageId], references: [id], onDelete: SetNull)

  cases CaseItem[]

  @@index([tenant, botId, createdAt])
  @@index([tenant, userId, createdAt])
}

model CodeRedemption {
  id         String   @id @default(cuid())
  tenant     String
  userId     String
  botId      String
  ruleId     String
  codePoolId String
  dateKey    String // "YYYY-MM-DD"
  redeemedAt DateTime @default(now())

  codePool CodePool @relation(fields: [codePoolId], references: [id], onDelete: Cascade)

  @@unique([tenant, botId, userId, ruleId, dateKey], name: "one_redeem_per_rule_per_day")
  @@index([tenant, botId, redeemedAt])
}

/**
 * ====================== Memory Layer ======================
 */

model MemoryItem {
  id        String   @id @default(cuid())
  tenant    String
  userRef   String
  key       String
  value     String
  ttlSec    Int?
  tags      Json?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([tenant, userRef, key], name: "tenant_userRef_key")
}

/**
 * ====================== Bot Secrets & Config ======================
 */

model BotSecret {
  id    String @id @default(cuid())
  botId String @unique

  // LINE
  channelSecret      String?
  channelAccessToken String?

  // ✅ Telegram
  telegramBotToken String? // ใช้รับส่งกับ Telegram Bot API

  // ✅ Facebook
  facebookPageAccessToken String?
  facebookVerifyToken     String?

  // OpenAI
  openaiApiKey String?

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)
}

model BotConfig {
  id     String @id @default(cuid())
  botId  String @unique
  tenant String

  // ค่า default สำหรับ AI config
  model        String @default("gpt-4o-mini")
  temperature  Float  @default(0.3)
  topP         Float  @default(1)
  maxTokens    Int    @default(800)
  systemPrompt String @default("")

  // สวิตช์เปิด/ปิดการใช้ OpenAI
  aiEnabled Boolean @default(true)

  // ผูกกับ AiPreset (optional)
  presetId  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot    Bot       @relation(fields: [botId], references: [id], onDelete: Cascade)
  preset AiPreset? @relation("AiPresetBotConfigs", fields: [presetId], references: [id])

  @@index([tenant])
}

/**
 * ====================== Cases & Daily Stats ======================
 */

model CaseItem {
  id     String @id @default(cuid())
  tenant String

  botId String
  bot   Bot    @relation(fields: [botId], references: [id], onDelete: Cascade)

  platform  String // หรือ Platform ถ้ามี enum
  sessionId String?
  session   ChatSession? @relation(fields: [sessionId], references: [id])

  userId String
  kind   String // "deposit" | "withdraw" | "activity" | ...
  text   String
  meta   Json?

  status      CaseStatus @default(PENDING)
  reviewNotes String?
  resolvedAt  DateTime?
  resolvedBy  String?

  imageIntakeId String?
  imageIntake   ImageIntake? @relation(fields: [imageIntakeId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
updatedAt DateTime @default(now()) @updatedAt

  @@index([botId, createdAt], map: "CaseItem_byBotDate")
  @@index([tenant, status, createdAt], map: "CaseItem_byTenantStatusDate")
  @@index([tenant, botId, status], map: "CaseItem_byTenantBotStatus")
}

model StatDaily {
  id        String   @id @default(cuid())
  botId     String
  tenant    String
  dateKey   String // YYYY-MM-DD
  total     Int      @default(0)
  text      Int      @default(0)
  follow    Int      @default(0)
  unfollow  Int      @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, dateKey], name: "botId_dateKey")
  @@index([tenant, dateKey])
}

/**
 * ====================== AI Presets & Knowledge ======================
 */

model AiPreset {
  id           String  @id @default(cuid())
  tenant       String
  name         String
  description  String?
  systemPrompt String?
  model        String
  temperature  Float?
  topP         Float?
  maxTokens    Int?

  // สถานะ preset
  status String @default("active")

  // back-relation ไปยัง BotConfig (ใช้ชื่อ relation เดียวกับฝั่ง BotConfig)
  botConfigs BotConfig[] @relation("AiPresetBotConfigs")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model KnowledgeDoc {
  id        String   @id @default(cuid())
  tenant    String
  title     String
  tags      String?
  body      String
  status    String   @default("active")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bots   BotKnowledge[]
  chunks KnowledgeChunk[]
}

model KnowledgeChunk {
  id        String   @id @default(cuid())
  tenant    String
  docId     String
  content   String
  embedding Json
  tokens    Int      @default(0)
  createdAt DateTime @default(now())
updatedAt DateTime @default(now()) @updatedAt

  doc KnowledgeDoc @relation(fields: [docId], references: [id], onDelete: Cascade)

  @@index([tenant])
  @@index([docId])
}

model BotKnowledge {
  botId     String
  docId     String
  createdAt DateTime @default(now())

  bot Bot          @relation(fields: [botId], references: [id], onDelete: Cascade)
  doc KnowledgeDoc @relation(fields: [docId], references: [id], onDelete: Cascade)

  @@id([botId, docId])
  @@unique([botId, docId], name: "botId_docId")
}

/**
 * ====================== Bot Intent / Category ======================
 */

model BotIntent {
  id        String   @id @default(cuid())
  tenant    String
  botId     String
  code      String
  title     String
  keywords  Json?
  fallback  String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot Bot @relation(fields: [botId], references: [id], onDelete: Cascade)

  @@unique([botId, code], name: "botId_code")
  @@index([tenant, botId])
}

/**
 * ====================== Chat Center (Sessions & Messages) ======================
 */

model ChatSession {
  id     String @id @default(cuid())
  tenant String

  bot   Bot    @relation(fields: [botId], references: [id])
  botId String
  platform String
  userId   String

  userName    String?
  displayName String?
  userAvatar  String?
  meta Json?
  firstMessageAt DateTime?
  lastMessageAt  DateTime?
  lastText       String?
  lastDirection  String? // "user" | "bot"

  // ====== META สำหรับ Chat Center ======
  status     String  @default("open") // "open" | "pending" | "closed"
  tags       String? // เก็บเป็น comma-separated เช่น "ฝากไม่เข้า, VIP"
  caseCount  Int     @default(0) // นับเคสที่ผูกกับห้องนี้
  hasProblem Boolean @default(false) // มีเคสปัญหาหรือไม่
  unread     Int     @default(0) // จำนวนข้อความที่ยังไม่อ่าน (optional)
  // =====================================

  messages ChatMessage[]
  cases    CaseItem[]
  mediaAssets MediaAsset[]

  createdAt    DateTime      @default(now())
  imageIntakes ImageIntake[]

  @@unique([botId, userId], map: "ChatSession_botId_userId_unique")
  @@index([botId, platform, lastMessageAt], map: "ChatSession_list_index")
  @@index([status])
  @@index([hasProblem])
}

model Conversation {
  id        String        @id @default(uuid())
  tenant    String
  bot       Bot           @relation(fields: [botId], references: [id])
  botId     String
  userId    String
  platform  String
  messages  ChatMessage[]
  createdAt DateTime      @default(now())
  updatedAt DateTime      @updatedAt

  @@unique([botId, userId], map: "Conversation_botId_userId_unique")
  @@index([botId, createdAt], map: "Conversation_bot_createdAt")
}

model ChatMessage {
  id     String @id @default(cuid())
  tenant String

  bot   Bot    @relation(fields: [botId], references: [id])
  botId String

  platform String // "line" | "telegram" | ...

  session   ChatSession? @relation(fields: [sessionId], references: [id])
  sessionId String?

  conversation   Conversation? @relation(fields: [conversationId], references: [id])
  conversationId String?

  senderType        String // "user" | "bot" | "admin"
  type              MessageType @default(TEXT)
  text              String      @default("")
  attachmentUrl     String?
  attachmentMeta    Json?
  platformMessageId String? // id ของข้อความจาก platform
  meta              Json?

  createdAt    DateTime      @default(now())
  imageIntakes ImageIntake[]
  mediaAssets  MediaAsset[]

  @@unique([sessionId, platformMessageId], map: "ChatMessage_session_platformMsg_unique")
  @@index([sessionId, createdAt], map: "ChatMessage_bySession")
  @@index([conversationId, createdAt], map: "ChatMessage_byConversation")
}

model LiveStream {
  id          String         @id @default(uuid())
  channelId   String
  title       String
  description String?
  status      String         @default("live")
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt
  questions   LiveQuestion[]
  polls       LivePoll[]
}

model LiveQuestion {
  id           String     @id @default(uuid())
  liveStreamId String
  userId       String?
  question     String
  answered     Boolean    @default(false)
  createdAt    DateTime   @default(now())
  liveStream   LiveStream @relation(fields: [liveStreamId], references: [id])
}

model LivePoll {
  id           String     @id @default(uuid())
  liveStreamId String
  question     String
  options      Json
  results      Json?
  closed       Boolean    @default(false)
  createdAt    DateTime   @default(now())
  liveStream   LiveStream @relation(fields: [liveStreamId], references: [id])
}

model FAQ {
  id        String   @id @default(uuid())
  botId     String
  question  String
  answer    String
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  bot Bot @relation(fields: [botId], references: [id])

  @@index([botId], map: "FAQ_botId")
}

model FaqEntry {
  id     String @id @default(cuid())
  tenant String

  botId String
  bot   Bot    @relation(fields: [botId], references: [id])

  question String // คำถาม
  answer   String // คำตอบ
  keywords String // เก็บเป็น string เดียวก่อน เช่น "ฝากไม่เข้า, เงินไม่เข้า"

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenant, botId])
}

model EngagementMessage {
  id         String    @id @default(uuid())
  botId      String
  platform   String    @default("line")
  channelId  String
  text       String
  interval   Int
  enabled    Boolean   @default(true)
  type       String    @default("text")
  meta       Json?
  lastSentAt DateTime?
  createdAt  DateTime  @default(now())
  updatedAt  DateTime  @updatedAt

  bot Bot @relation(fields: [botId], references: [id])

  @@index([botId, platform, channelId], map: "EngagementMessage_channel")
}

enum MessageType {
  TEXT
  IMAGE
  FILE
  STICKER
  SYSTEM
  RICH
  INLINE_KEYBOARD
}

model CampaignSchedule {
  id             String                 @id @default(cuid())
  campaignId     String
  cronExpr       String
  timezone       String
  status         CampaignScheduleStatus @default(ACTIVE)
  startAt        DateTime?
  endAt          DateTime?
  idempotencyKey String?                @unique
  lastRunAt      DateTime?
  nextRunAt      DateTime?
  meta           Json?
  createdAt      DateTime               @default(now())
  updatedAt      DateTime               @updatedAt

  @@index([campaignId], map: "CampaignSchedule_campaignId")
}

model CampaignTask {
  id              String   @id @default(cuid())
  tenant          String
  botId           String
  code            String // เช่น "PROMO_DEC_STEP1"
  title           String // ชื่อกิจกรรม
  description     String // อธิบาย
  instructions    String // ข้อความบรีฟให้ AI ใช้ตรวจ
  exampleImageUrl String? // รูปตัวอย่างว่าถูกต้อง
  isActive        Boolean  @default(true)
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@index([tenant, botId, code])
}

model ImageSample {
  id     String @id @default(cuid())
  tenant String
  botId  String
  label  String
  ahash  String
  note      String?
  filePath  String?
  mime      String?
  size      Int?
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([tenant, botId, label])
  @@index([tenant, botId, ahash])
}

model CampaignUserProgress {
  id             String   @id @default(cuid())
  tenant         String
  botId          String
  userId         String // line userId
  taskCode       String // อ้าง CampaignTask.code
  step           Int // ขั้นตอนที่ถึงแล้ว
  isCompleted    Boolean  @default(false)
  lastImageUrl   String?
  lastResultJson Json?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@index([tenant, botId, userId, taskCode])
}

/**
 * ====================== ManyChat-style Quick Replies ==================
 */

model QuickReplySession {
  id String @id @default(cuid())

  // Contact & Channel
  channel   String // "line" | "telegram" | "messenger" | "webchat"
  contactId String // userId / chatId / psid / sessionId
  promptKey String // flow node id

  // Status
  status String @default("pending") // "pending" | "resolved" | "expired"

  // Message ID (if returned by channel API)
  messageId String?

  // Selected choice (when resolved)
  selectedChoiceId String?

  // Follow-up settings
  followupDelayMs    BigInt?
  followupDueAtMs    BigInt?
  followupSentAtMs   BigInt?

  // Retry settings
  retryMax   Int @default(0) // capped at 5
  retryCount Int @default(0)

  // Timestamps
  createdAtMs   BigInt
  resolvedAtMs  BigInt?

  @@unique([channel, contactId, promptKey, createdAtMs])
  @@index([status, followupDueAtMs])
  @@index([channel, contactId, createdAtMs])
}

enum CampaignScheduleStatus {
  ACTIVE
  PAUSED
  DISABLED
}

enum CodeStatus {
  AVAILABLE
  USED
  EXPIRED
}

enum ImageClass {
  SLIP
  ACTIVITY
  OTHER
}

enum CaseStatus {
  PENDING
  APPROVED
  REJECTED
  NEED_MORE_INFO
}
